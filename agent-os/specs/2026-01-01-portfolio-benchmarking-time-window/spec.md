# Specification: Portfolio Benchmarking Time Window

## Goal
Enable users to simulate and benchmark portfolio performance over a specific time window by uploading a portfolio JSON file, specifying a budget and date range, then visualizing performance against S&P 500 and risk-free asset benchmarks with detailed ticker-level breakdown.

## User Stories
- As an investor, I want to upload my optimized portfolio JSON file and see how it would have performed historically so that I can validate my portfolio strategy
- As an investor, I want to specify an investment budget that gets distributed according to portfolio weights so that I can simulate realistic investment scenarios
- As an investor, I want to compare my portfolio's performance against the S&P 500 and risk-free assets over the same period so that I can evaluate if my active management adds value

## Core Requirements

### Functional Requirements
- Users upload a portfolio JSON file (generated by portfolio optimizer) containing tickers, weights, and prices
- Users specify an investment budget (dollar amount) that gets allocated across portfolio holdings based on weights
- Users select a time window using date range inputs (start date and end date)
- Users enter a risk-free rate (annual percentage) for comparison calculations
- System fetches historical price data for all portfolio tickers from the selected start date to end date
- System fetches S&P 500 (^GSPC) historical data for the same period
- System calculates number of shares purchased for each ticker at start date prices
- System tracks portfolio value over time based on actual historical prices
- System calculates equivalent S&P 500 investment performance
- System calculates risk-free asset value using compound interest formula
- Display multi-line chart showing three performance lines: Portfolio, S&P 500, and Risk-free asset
- Display summary table comparing aggregated portfolio performance vs benchmarks with total profit/loss

### Non-Functional Requirements
- Chart updates should render smoothly using existing Plotly infrastructure
- File upload should validate JSON structure and provide clear error messages for invalid files
- Date validation should prevent invalid ranges (start >= end, future dates)
- API should handle missing ticker data gracefully (skip or notify user)
- Match existing dark theme styling and UI patterns from other features
- Support internationalization (i18n) for all new UI text elements

## Visual Design
No mockups provided. Follow existing UI patterns:
- Use existing form input styling (optimizer-input, hedge-input classes)
- Use existing button styling (optimizer-submit-button pattern)
- Use existing chart container patterns (charts-container, chart-wrapper)
- Follow RegressionChart.jsx styling for multi-line charts
- Use existing dark theme color palette (cyan primary, blue secondary)
- Results table should follow StockScreener results table styling patterns

## Reusable Components

### Existing Code to Leverage
- **DateInput.jsx**: Reuse entire component for date range selection with debouncing and validation
- **Backend validation**: Use `validate_date_range()` function from app.py for date validation logic
- **Data fetching pattern**: Model after `generate_data()` function in app.py for fetching historical prices via yfinance
- **Chart component patterns**: Follow RegressionChart.jsx structure for multi-line Plotly charts
- **File upload pattern**: Reference Optimizer.jsx file upload implementation (FileReader, readAsText, JSON parsing)
- **Form styling**: Reuse optimizer-input, optimizer-form-group CSS classes
- **Error handling**: Follow existing error state patterns from App.jsx and other components
- **Loading states**: Use existing loading state patterns and messages

### New Components Required
- **PortfolioBenchmark.jsx**: New main component for the benchmarking feature
  - Cannot reuse existing components entirely as this combines portfolio upload, simulation inputs, and comparative benchmarking in a unique workflow
  - Should compose existing DateInput for date selection
- **BenchmarkChart.jsx**: New chart component for three-line performance comparison
  - While similar to RegressionChart.jsx, needs different data structure and legends for portfolio vs benchmarks
- **BenchmarkResultsTable.jsx**: New table component for aggregated performance summary
  - Shows three rows: Portfolio, S&P 500, Risk-free asset with initial value, final value, and profit/loss for each

## Technical Approach

### Database
No database persistence required per requirements. All calculations are ephemeral and performed on-demand.

### API
New Flask endpoint: `/api/benchmark-portfolio` (POST)
- **Request payload**:
  - portfolio_data: JSON object with weights, prices, tickers
  - budget: float (investment amount)
  - start_date: string (YYYY-MM-DD)
  - end_date: string (YYYY-MM-DD)
  - risk_free_rate: float (annual rate as decimal, e.g., 0.04)
- **Response**:
  - portfolio_timeline: {date: value} dict of portfolio values over time
  - sp500_timeline: {date: value} dict of S&P 500 equivalent investment
  - riskfree_timeline: {date: value} dict of risk-free asset values
  - summary: {portfolio_initial_value, portfolio_final_value, portfolio_profit_loss, sp500_initial_value, sp500_final_value, sp500_profit_loss, riskfree_initial_value, riskfree_final_value, riskfree_profit_loss}
- **Error handling**: Return 400 for validation errors, 404 for missing ticker data, 500 for calculation failures

### Backend Logic
- Parse portfolio JSON to extract weights and tickers
- Use yfinance to fetch historical prices for all tickers (start_date to end_date)
- Fetch S&P 500 (^GSPC) data for same period
- For each ticker: calculate shares = (budget × weight) / price_at_start_date
- Build portfolio_timeline: for each date, sum(shares × price_on_date) across all tickers
- Build sp500_timeline: sp500_shares = budget / sp500_price_at_start, track sp500_shares × price_on_date
- Build riskfree_timeline: For each date, calculate days_elapsed from start, value = budget × (1 + rate)^(days_elapsed/365)
- Calculate aggregated profit/loss for each investment type: (final_value - initial_value)
- Return all timelines and summary as JSON

### Frontend
- Create PortfolioBenchmark.jsx component with:
  - File input for JSON upload (hidden input with styled button trigger)
  - Budget input (number field with dollar validation)
  - DateInput component integration (pass callback for date changes)
  - Risk-free rate input (number field with percentage helper text)
  - Submit button (disabled while loading)
  - Loading state display with progress message
  - Error state display with user-friendly messages
- Create BenchmarkChart.jsx using react-plotly.js:
  - Three line traces: portfolio (cyan), S&P 500 (blue), risk-free (gray)
  - Consistent styling with existing charts (dark theme, gridlines, responsive)
  - Legend showing all three lines
  - Y-axis labeled "Portfolio Value ($)"
  - X-axis labeled "Date"
- Create BenchmarkResultsTable.jsx:
  - Three rows: Portfolio, S&P 500, Risk-free asset
  - Columns: Investment type, Initial value, Final value, Profit/Loss (color-coded green/red), Return %
  - Comparison section showing portfolio outperformance/underperformance vs benchmarks
- Add new view option to Selector.jsx for "Benchmark" navigation
- Update App.jsx to include new route/view for PortfolioBenchmark component

### Testing
- Unit tests for backend portfolio value calculations
- Unit tests for risk-free asset compound interest calculation
- API integration tests for /api/benchmark-portfolio endpoint
- Frontend component tests for file upload validation
- Frontend tests for date range validation
- End-to-end test: upload valid portfolio, set parameters, verify chart renders

## Out of Scope
- Saving benchmark results to file system or database
- Multiple portfolio comparison (side-by-side)
- Transaction costs or trading fees in calculations
- Dividend reinvestment or adjustments
- Portfolio rebalancing during the time window
- Intraday price data (only daily close prices)
- Real-time or live data
- Sector/industry breakdown of holdings
- Tax implications or after-tax returns
- Currency conversion (assumes all USD)
- Custom benchmark indices (only S&P 500 supported)

## Success Criteria
- Users can successfully upload portfolio JSON files and see immediate feedback
- Chart renders smoothly with three distinct lines showing portfolio, S&P 500, and risk-free performance
- Results table accurately shows aggregated profit/loss for portfolio and benchmarks with clear visual indicators
- Date validation prevents invalid inputs and displays helpful error messages
- Performance calculations match manual verification for sample portfolios
- UI matches existing design patterns and dark theme styling
- All new UI text is internationalized and available in English and Korean
